<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Redux-like state container in SwiftUI. Best practices. | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Redux-like state container in SwiftUI. Best practices." />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Last week we talked about building a state container similar to Redux in SwiftUI. Redux provides a single source of truth, which eliminates tons of bugs produced by multiple states across the app. This week we will talk about best practices in building Redux-based apps which allows us to keep our codebase simple and clean." />
<meta property="og:description" content="Last week we talked about building a state container similar to Redux in SwiftUI. Redux provides a single source of truth, which eliminates tons of bugs produced by multiple states across the app. This week we will talk about best practices in building Redux-based apps which allows us to keep our codebase simple and clean." />
<link rel="canonical" href="http://localhost:4000/2019/09/25/redux-like-state-container-in-swiftui-part2/" />
<meta property="og:url" content="http://localhost:4000/2019/09/25/redux-like-state-container-in-swiftui-part2/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/store.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-25T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/store.png" />
<meta property="twitter:title" content="Redux-like state container in SwiftUI. Best practices." />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/09/25/redux-like-state-container-in-swiftui-part2/"},"url":"http://localhost:4000/2019/09/25/redux-like-state-container-in-swiftui-part2/","image":"http://localhost:4000/public/store.png","author":{"@type":"Person","name":"Code4You"},"headline":"Redux-like state container in SwiftUI. Best practices.","description":"Last week we talked about building a state container similar to Redux in SwiftUI. Redux provides a single source of truth, which eliminates tons of bugs produced by multiple states across the app. This week we will talk about best practices in building Redux-based apps which allows us to keep our codebase simple and clean.","dateModified":"2019-09-25T00:00:00+08:00","datePublished":"2019-09-25T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Redux-like state container in SwiftUI. Best practices.</h2>
  <time datetime="2019-09-25T00:00:00+08:00" class="post-date">25 Sep 2019</time>
  <p>Last week we talked about <a href="/2019/09/18/redux-like-state-container-in-swiftui/">building a state container similar to Redux in SwiftUI</a>. <em>Redux</em> provides a single source of truth, which eliminates tons of bugs produced by multiple states across the app. This week we will talk about best practices in building <em>Redux-based</em> apps which allows us to keep our codebase simple and clean.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="state-normalization">State normalization</h4>
<p><em>Redux</em> stores the whole app’s state as a single source of truth. It allows us to keep our <em>User Interface</em> in sync with the app state. But to achieve this, we have to normalize our state. Let’s take a look at the example.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">allTasks</span><span class="p">:</span> <span class="p">[</span><span class="kt">Task</span><span class="p">]</span>
    <span class="k">var</span> <span class="nv">favorited</span><span class="p">:</span> <span class="p">[</span><span class="kt">Task</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have an <em>AppState</em> struct which stores a task list and favorited tasks. It looks straightforward, but it has one big downside. Assume that you have the edit task screen where you can modify the selected task. Whenever the user hits the save button, you have to find and update a particular task in the allTasks list and favorited list. It can be error-prone and lead to a performance issue as soon as you have a long list of tasks.</p>

<p>Let’s improve performance by normalizing our state struct. First of all, we need to store our tasks in <em>Dictionary</em> where task id is the key and task itself is the value. <em>Dictionary</em> can retrieve the value by key in constant <strong>(O(1))</strong> time, but it doesn’t keep the order. We can create an array with ids to save the order. Let’s take a look at the normalized version of our state.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">tasks</span><span class="p">:</span> <span class="p">[</span><span class="kt">Int</span><span class="p">:</span> <span class="kt">Task</span><span class="p">]</span>
    <span class="k">var</span> <span class="nv">allTasks</span><span class="p">:</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span>
    <span class="k">var</span> <span class="nv">favorited</span><span class="p">:</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we store our tasks in the <em>Dictionary</em> where task <em>id</em> is the key, and the task is the value. We also store arrays of identifiers for all tasks and favorited ones. By using identifiers instead of copies, we achieve a centralized state persistence which keeps our <em>User Interface</em> and data in sync.</p>

<h4 id="state-composition">State composition</h4>
<p>It is very natural to store your app’s state as a single struct, but it simply can blow up as soon as you add more and more fields to your state struct. We can use state composition to solve this issue. Let’s take a look at the example.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">AppState</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">calendar</span><span class="p">:</span> <span class="kt">CalendarState</span>
    <span class="k">var</span> <span class="nv">trends</span><span class="p">:</span> <span class="kt">TrendsState</span>
    <span class="k">var</span> <span class="nv">settings</span><span class="p">:</span> <span class="kt">SettingState</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the example above, we divide our state into three dedicated pieces and compose them into <em>AppState</em>.</p>

<h4 id="reducer-composition">Reducer composition</h4>
<p>Another important component of our <em>Redux-like</em> state container is <em>Reducer</em>. We can extract and compose it as we do with state struct. It will allow us to respect a <em>Single Responsibility</em> principle and keep our reducers small and clean.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">AppAction</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nf">calendar</span><span class="p">(</span><span class="nv">action</span><span class="p">:</span> <span class="kt">CalendarAction</span><span class="p">)</span>
    <span class="k">case</span> <span class="nf">trends</span><span class="p">(</span><span class="nv">action</span><span class="p">:</span> <span class="kt">TrendsAction</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">trendsReducer</span><span class="p">(</span>
    <span class="nv">state</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">TrendsState</span><span class="p">,</span>
    <span class="nv">action</span><span class="p">:</span> <span class="kt">TrendsAction</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">TrendsAction</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="c1">// Implement your state changes here</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">calendarReducer</span><span class="p">(</span>
    <span class="nv">state</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">CalendarState</span><span class="p">,</span>
    <span class="nv">action</span><span class="p">:</span> <span class="kt">CalendarAction</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">CalendarAction</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="c1">// Implement your state changes here</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">appReducer</span><span class="p">(</span>
    <span class="nv">state</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">AppState</span><span class="p">,</span>
    <span class="nv">action</span><span class="p">:</span> <span class="kt">AppAction</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">AppAction</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">calendar</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">calendarReducer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">.</span><span class="n">calendar</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">AppAction</span><span class="o">.</span><span class="n">calendar</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="k">case</span> <span class="kd">let</span> <span class="o">.</span><span class="nf">trends</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
        <span class="nf">trendsReducer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">.</span><span class="n">trends</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">AppAction</span><span class="o">.</span><span class="n">trends</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kt">Empty</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="derived-stores">Derived stores</h4>
<p>Another way of composition that should simplify our architecture is derived stores. I don’t want to expose the whole app state to every view or update views on not related state updates. Here is a small example from my CardioBot app.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>

<span class="kd">struct</span> <span class="kt">RootView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@EnvironmentObject</span> <span class="k">var</span> <span class="nv">store</span><span class="p">:</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">AppState</span><span class="p">,</span> <span class="kt">AppAction</span><span class="o">&gt;</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">TabView</span> <span class="p">{</span>
            <span class="kt">NavigationView</span> <span class="p">{</span>
                <span class="kt">SummaryContainerView</span><span class="p">()</span>
                    <span class="o">.</span><span class="nf">navigationBarTitle</span><span class="p">(</span><span class="s">"today"</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">environmentObject</span><span class="p">(</span>
                        <span class="n">store</span><span class="o">.</span><span class="nf">derived</span><span class="p">(</span>
                            <span class="nv">deriveState</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">summary</span><span class="p">,</span>
                            <span class="nv">deriveAction</span><span class="p">:</span> <span class="kt">AppAction</span><span class="o">.</span><span class="n">summary</span>
                        <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span><span class="o">.</span><span class="n">tabItem</span> <span class="p">{</span>
                <span class="kt">Image</span><span class="p">(</span><span class="nv">systemName</span><span class="p">:</span> <span class="s">"heart.fill"</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">imageScale</span><span class="p">(</span><span class="o">.</span><span class="n">large</span><span class="p">)</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"today"</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="kt">NavigationView</span> <span class="p">{</span>
                <span class="kt">TrendsContainerView</span><span class="p">()</span>
                    <span class="o">.</span><span class="nf">navigationBarTitle</span><span class="p">(</span><span class="s">"trends"</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">environmentObject</span><span class="p">(</span>
                        <span class="n">store</span><span class="o">.</span><span class="nf">derived</span><span class="p">(</span>
                            <span class="nv">deriveState</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">trends</span><span class="p">,</span>
                            <span class="nv">deriveAction</span><span class="p">:</span> <span class="kt">AppAction</span><span class="o">.</span><span class="n">trends</span>
                        <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">}</span><span class="o">.</span><span class="n">tabItem</span> <span class="p">{</span>
                <span class="kt">Image</span><span class="p">(</span><span class="nv">systemName</span><span class="p">:</span> <span class="s">"chevron.up.circle.fill"</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">imageScale</span><span class="p">(</span><span class="o">.</span><span class="n">large</span><span class="p">)</span>
                <span class="kt">Text</span><span class="p">(</span><span class="s">"trends"</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, every tab of my app gets its part of the state via the derived store. We still use the global store to handle all the state mutation. Derived store works as a pipeline that allows us to transform the state from the global store and redirect actions to the global store. Let’s take a look at how we can implement the <em>derived</em> method for our <em>Store</em> class.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="n">derived</span><span class="o">&lt;</span><span class="kt">DerivedState</span><span class="p">:</span> <span class="kt">Equatable</span><span class="p">,</span> <span class="kt">ExtractedAction</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nv">deriveState</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">DerivedState</span><span class="p">,</span>
    <span class="nv">embedAction</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">ExtractedAction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Action</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">DerivedState</span><span class="p">,</span> <span class="kt">ExtractedAction</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">DerivedState</span><span class="p">,</span> <span class="kt">ExtractedAction</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="nv">initialState</span><span class="p">:</span> <span class="nf">deriveState</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
        <span class="nv">reducer</span><span class="p">:</span> <span class="kt">Reducer</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">_</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="nf">embedAction</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
            <span class="k">return</span> <span class="kt">Empty</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="nv">environment</span><span class="p">:</span> <span class="p">()</span>
    <span class="p">)</span>
    <span class="err">$</span><span class="n">state</span>
        <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="n">deriveState</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">removeDuplicates</span><span class="p">()</span>
        <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">store</span><span class="o">.</span><span class="err">$</span><span class="n">state</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">store</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="conclusion">Conclusion</h4>
<p>Today we talked about two important strategies which we should use during app development using <em>Redux-like</em> state containers in SwiftUI. Both normalization and composition keep our app state simple and maintainable. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading and see you next week!</p>

<ol>
  <li><a href="/2019/09/18/redux-like-state-container-in-swiftui/">Redux-like state container in SwiftUI. Basics</a></li>
  <li>Redux-like state container in SwiftUI. Best practices</li>
  <li><a href="/2019/10/02/redux-like-state-container-in-swiftui-part3/">Redux-like state container in SwiftUI. Container Views.</a></li>
  <li><a href="/2021/02/03/redux-like-state-container-in-swiftui-part4/">Redux-like state container in SwiftUI. Connectors.</a></li>
</ol>

<h4 id="references">References</h4>
<p>The series of posts have built on a foundation of ideas started by other libraries, particularly Redux, Elm, and TCA.</p>
<ol>
  <li><a href="https://developer.apple.com/videos/play/wwdc2020/10040/">WWDC20 - Data Essentials in SwiftUI</a></li>
  <li><a href="https://redux.js.org">Redux</a> - The JavaScript library that popularized unidirectional data flow.</li>
  <li><a href="https://guide.elm-lang.org/architecture/">The Elm Architecture</a> - A purely functional language and runtime that inspired the creation of Redux.</li>
  <li><a href="https://github.com/pointfreeco/swift-composable-architecture">The Composable Architecture</a> - A library that bridges concepts from the Elm Architecture and Redux to Swift. It introduced the “environment” and “effect” patterns that this series covers.</li>
</ol>


</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
