<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Dependency Injection in Swift with Protocols | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Dependency Injection in Swift with Protocols" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="There are a lot of third-party libraries which provide Dependency Injection for Swift apps. In my opinion, Swift has a powerful type system which gives us the ability to make type-safe Dependency Injection easily. Today we will talk about using Dependency Injection in Swift with the power of protocols." />
<meta property="og:description" content="There are a lot of third-party libraries which provide Dependency Injection for Swift apps. In my opinion, Swift has a powerful type system which gives us the ability to make type-safe Dependency Injection easily. Today we will talk about using Dependency Injection in Swift with the power of protocols." />
<link rel="canonical" href="http://localhost:4000/2019/03/06/dependency-injection-in-swift-with-protocols/" />
<meta property="og:url" content="http://localhost:4000/2019/03/06/dependency-injection-in-swift-with-protocols/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-03-06T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Dependency Injection in Swift with Protocols" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/03/06/dependency-injection-in-swift-with-protocols/"},"url":"http://localhost:4000/2019/03/06/dependency-injection-in-swift-with-protocols/","author":{"@type":"Person","name":"Code4You"},"headline":"Dependency Injection in Swift with Protocols","description":"There are a lot of third-party libraries which provide Dependency Injection for Swift apps. In my opinion, Swift has a powerful type system which gives us the ability to make type-safe Dependency Injection easily. Today we will talk about using Dependency Injection in Swift with the power of protocols.","dateModified":"2019-03-06T00:00:00+08:00","datePublished":"2019-03-06T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Dependency Injection in Swift with Protocols</h2>
  <time datetime="2019-03-06T00:00:00+08:00" class="post-date">06 Mar 2019</time>
  <p>There are a lot of third-party libraries which provide Dependency Injection for Swift apps. In my opinion, Swift has a powerful type system which gives us the ability to make type-safe Dependency Injection easily. Today we will talk about using Dependency Injection in Swift with the power of protocols.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="protocol-composition">Protocol Composition</h4>
<p>As I said before protocols are one of my favorite language features in Swift, especially protocol composition, which gives us an opportunity to compose multiple protocols together in one type. Let’s take a look at the implementation of the Service Locator pattern in Swift and how we can improve it with the usage of protocol composition.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">HasUserDefaults</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">HasUrlSession</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">HasHealthStore</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">store</span><span class="p">:</span> <span class="kt">HKHealthStore</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">Dependencies</span><span class="p">:</span> <span class="kt">HasUserDefaults</span><span class="p">,</span> <span class="kt">HasUrlSession</span><span class="p">,</span> <span class="kt">HasHealthStore</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span>
    <span class="k">let</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span>
    <span class="k">let</span> <span class="nv">store</span><span class="p">:</span> <span class="kt">HKHealthStore</span>

    <span class="nf">init</span><span class="p">(</span>
        <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span> <span class="o">=</span> <span class="o">.</span><span class="n">standard</span><span class="p">,</span>
        <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span> <span class="o">=</span> <span class="o">.</span><span class="n">shared</span><span class="p">,</span>
        <span class="nv">store</span><span class="p">:</span> <span class="kt">HKHealthStore</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">()</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">userDefaults</span> <span class="o">=</span> <span class="n">userDefaults</span>
        <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have a bunch of protocols which describe our dependencies. <em>Dependencies</em> struct contains all of our service classes in the app. Generally, we can create and store an instance of <em>Dependencies</em> struct in <em>AppDelegate</em> or root coordinator. Now let’s take a look at the usage of our dependency container.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Dependencies</span> <span class="o">=</span> <span class="kt">HasUserDefaults</span> <span class="o">&amp;</span> <span class="kt">HasUrlSession</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">dependencies</span><span class="p">:</span> <span class="kt">Dependencies</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">userDefaults</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">userDefaults</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">session</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">nibName</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">bundle</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have <em>ViewController</em> which describes its dependencies via a typealias and protocol composition. In the <em>init</em> method, we easily extract our dependencies into field variables. All we need is the passing instance of our <em>Dependencies</em> struct to <em>ViewController</em>, and <em>ViewController</em> will be able to access dependencies only defined in typealias.</p>

<p>Next time when your <em>ViewController</em> will need another dependency all you need to do is add it to typealias and extract it into the variable. You don’t need to change the creation of <em>ViewController</em>, because you already pass all the dependencies.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Dependencies</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">mocked</span><span class="p">:</span> <span class="kt">Dependencies</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">Dependencies</span><span class="p">(</span>
            <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span><span class="p">(</span><span class="nv">suiteName</span><span class="p">:</span> <span class="kd">#file</span><span class="p">),</span>
            <span class="nv">session</span><span class="p">:</span> <span class="kt">MockedUrlSession</span><span class="p">(),</span>
            <span class="nv">store</span><span class="p">:</span> <span class="kt">MockedHealthStore</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The example above shows how we can create the mocked version of dependencies to use it for Unit-Testing.</p>

<h4 id="abstract-factory">Abstract Factory</h4>
<p>Another option for Dependency Injection is the Abstract Factory pattern. I love to use it to extract the creation of complex objects like <em>ViewControllers</em> and its dependencies. Let’s take a look at the Swift version of the Abstract Factory pattern by using protocols and extensions.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">DependencyFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeHealthService</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">HealthService</span>
    <span class="kd">func</span> <span class="nf">makeSettingsSevice</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SettingsService</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">Dependencies</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">healthStore</span><span class="p">:</span> <span class="kt">HKHealthStore</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span>

    <span class="nf">init</span><span class="p">(</span>
        <span class="nv">healthStore</span><span class="p">:</span> <span class="kt">HKHealthStore</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">(),</span>
        <span class="nv">userDefaults</span><span class="p">:</span> <span class="kt">UserDefaults</span> <span class="o">=</span> <span class="o">.</span><span class="n">standard</span>
    <span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">healthStore</span> <span class="o">=</span> <span class="n">healthStore</span>
        <span class="k">self</span><span class="o">.</span><span class="n">userDefaults</span> <span class="o">=</span> <span class="n">userDefaults</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Dependencies</span><span class="p">:</span> <span class="kt">DependencyFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeHealthService</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">HealthService</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">HealthService</span><span class="p">(</span><span class="nv">store</span><span class="p">:</span> <span class="n">healthStore</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">makeSettingsSevice</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SettingsService</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">Settings</span><span class="p">(</span><span class="n">defaults</span><span class="p">:</span> <span class="n">userDefaults</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have <em>DependencyFactory</em> protocol which describes factory methods for every dependency in our app. We also have small <em>Dependencies</em> struct which stores low-level dependencies. By using the extension, we add <em>DependencyFactory</em> protocol conformance to <em>Dependencies</em> struct. Now let’s take a look at <em>ViewControllerFactory</em>, which describes <em>ViewController</em> creation process.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">ViewControllerFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeCalendarViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CalendarViewController</span>
    <span class="kd">func</span> <span class="nf">makeDayViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">DayViewController</span>
    <span class="kd">func</span> <span class="nf">makeSettingsViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SettingsViewController</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Dependencies</span><span class="p">:</span> <span class="kt">ViewControllerFactory</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">makeCalendarViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">CalendarViewController</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">CalendarViewController</span><span class="p">(</span>
            <span class="nv">healthService</span><span class="p">:</span> <span class="nf">makeHealthService</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">makeDayViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">DayViewController</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">DayViewController</span><span class="p">(</span>
            <span class="nv">healthService</span><span class="p">:</span> <span class="nf">makeHealthService</span><span class="p">(),</span>
            <span class="nv">settingsService</span><span class="p">:</span> <span class="nf">makeSettingsSevice</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">makeSettingsViewController</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">SettingsViewController</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">SettingsViewController</span><span class="p">(</span>
            <span class="nv">settingsService</span><span class="p">:</span> <span class="nf">makeSettingsSevice</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We use <em>ViewControllerFactory</em> to create every <em>ViewController</em> in our app, for more complex apps we can have more than one <em>ViewController</em> factory based on the user flow. Here we also use an extension to add protocol conformance to <em>Dependencies</em> struct. It is time to see how we can use these factories while using Coordinators or Flow Controllers.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">FlowControllerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">startSettings</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">FlowController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">factory</span><span class="p">:</span> <span class="kt">ViewControllerFactory</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">factory</span><span class="p">:</span> <span class="kt">ViewControllerFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">factory</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="nf">add</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="nf">makeCalendarViewController</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">FlowController</span><span class="p">:</span> <span class="kt">FlowControllerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">startSettings</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">show</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="nf">makeSettingsViewController</span><span class="p">(),</span> <span class="nv">sender</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can create an instance of <em>Dependencies</em> struct in <em>AppDelegate</em> and pass it to the main <em>Flow Controller</em> of the app. By extracting creation of <em>ViewControllers</em> into factories, we keep our <em>Flow Controllers</em> small and responsible only for controlling user-flow.</p>

<blockquote>
  <p>To learn more about Flow Controllers and Coordinator pattern, take a look at my dedicate <a href="/2019/02/20/navigation-with-flow-controllers/">“Navigation with Flow Controllers”</a> post.</p>
</blockquote>

<h4 id="conclusion">Conclusion</h4>
<p>Today we discussed two Dependency Injection techniques. Both of them use Swift language features without any third-party dependencies. Just take a look at them and choose which will work better for you. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
