<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Extracting presentation logic to make it testable | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Extracting presentation logic to make it testable" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Last week we touched the entirely new topic on my blog. This week we will continue the Unit Testing subject. One of the smells of a good architecture is the ability to cover it with Unit Tests. Today we will talk about extracting Presentation logic into testable and straightforward pieces of code." />
<meta property="og:description" content="Last week we touched the entirely new topic on my blog. This week we will continue the Unit Testing subject. One of the smells of a good architecture is the ability to cover it with Unit Tests. Today we will talk about extracting Presentation logic into testable and straightforward pieces of code." />
<link rel="canonical" href="http://localhost:4000/2019/05/01/extracting-presentation-logic-to-make-it-testable/" />
<meta property="og:url" content="http://localhost:4000/2019/05/01/extracting-presentation-logic-to-make-it-testable/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-01T00:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Extracting presentation logic to make it testable" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/05/01/extracting-presentation-logic-to-make-it-testable/"},"url":"http://localhost:4000/2019/05/01/extracting-presentation-logic-to-make-it-testable/","author":{"@type":"Person","name":"Code4You"},"headline":"Extracting presentation logic to make it testable","description":"Last week we touched the entirely new topic on my blog. This week we will continue the Unit Testing subject. One of the smells of a good architecture is the ability to cover it with Unit Tests. Today we will talk about extracting Presentation logic into testable and straightforward pieces of code.","dateModified":"2019-05-01T00:00:00+08:00","datePublished":"2019-05-01T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Extracting presentation logic to make it testable</h2>
  <time datetime="2019-05-01T00:00:00+08:00" class="post-date">01 May 2019</time>
  <p>Last week we touched the entirely new topic on my blog. This week we will continue the Unit Testing subject. One of the smells of a good architecture is the ability to cover it with Unit Tests. Today we will talk about extracting Presentation logic into testable and straightforward pieces of code.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<blockquote>
  <p>To learn more about the basics of Unit Testing, take a look at my <a href="/2019/04/24/starting-unit-testing-with-model-layer/">“Starting Unit Testing with Model layer”</a> post.</p>
</blockquote>

<h4 id="typical-issues">Typical issues</h4>
<p>Assume that you have a screen presenting a list of the progress of your TV show collection. Every cell presents TV show poster, title, and next episode number and title. Let’s see on typical <em>ShowCell</em> code:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Show</span><span class="p">:</span> <span class="kt">Decodable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">images</span><span class="p">:</span> <span class="kt">Images</span>
    <span class="k">let</span> <span class="nv">unwatched</span><span class="p">:</span> <span class="p">[</span><span class="kt">Episode</span><span class="p">]</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ShowCell</span><span class="p">:</span> <span class="kt">UICollectionViewCell</span> <span class="p">{</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">titleLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">nextEpisodeLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">posterImageView</span><span class="p">:</span> <span class="kt">UIImageView</span><span class="o">!</span>

    <span class="k">var</span> <span class="nv">show</span><span class="p">:</span> <span class="kt">Show</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">show</span> <span class="o">=</span> <span class="n">show</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>

            <span class="n">posterImageView</span><span class="o">.</span><span class="nf">setImage</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">show</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">poster</span><span class="p">)</span>
            <span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">show</span><span class="o">.</span><span class="n">title</span>

            <span class="k">if</span> <span class="k">let</span> <span class="nv">nextEpisode</span> <span class="o">=</span> <span class="n">show</span><span class="o">.</span><span class="n">unwatched</span><span class="o">.</span><span class="n">first</span> <span class="p">{</span>
                <span class="n">nextEpisodeLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">"S</span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">season</span><span class="se">)</span><span class="s">E</span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">number</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">title</span><span class="se">)</span><span class="s">"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code looks very simple, and at first glance, there are no huge problems. But there are probably a few downsides:</p>

<ol>
  <li>
    <p>We are breaking SOLID principles by mixing presentation logic with view logic inside <em>ShowCell</em>. Our cell is responsible for laying out views and formatting show data into user presentable format.</p>
  </li>
  <li>
    <p>We want to test our data formatting logic to be sure that we are presenting the correct information to the user. But it is hard to cover <em>UIViews</em> with Unit Tests, and there is no clear intention on what you test, layout or presentation logic (we will talk about UI testing in next posts).</p>
  </li>
</ol>

<h4 id="refactoring">Refactoring</h4>
<p>Let’s start to refactor our codebase. First of all, I want to reuse this <em>ShowCell</em> across the app for presenting search response, TV shows collection progress, etc.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">PosterPresentable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">subtitle</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">poster</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">PosterCell</span><span class="p">:</span> <span class="kt">UICollectionViewCell</span> <span class="p">{</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">titleLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">subtitleLabel</span><span class="p">:</span> <span class="kt">UILabel</span><span class="o">!</span>
    <span class="kd">@IBOutlet</span> <span class="kd">private</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">posterImageView</span><span class="p">:</span> <span class="kt">UIImageView</span><span class="o">!</span>

    <span class="k">var</span> <span class="nv">presentation</span><span class="p">:</span> <span class="kt">PosterPresentable</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">presentation</span> <span class="o">=</span> <span class="n">presentation</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>

            <span class="n">posterImageView</span><span class="o">.</span><span class="nf">setImage</span><span class="p">(</span><span class="nv">from</span><span class="p">:</span> <span class="n">presentation</span><span class="o">.</span><span class="n">poster</span><span class="p">)</span>
            <span class="n">titleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">presentation</span><span class="o">.</span><span class="n">title</span>
            <span class="n">subtitleLabel</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">presentation</span><span class="o">.</span><span class="n">subtitle</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have refactored version of our <em>ShowCell</em>, now it is called <em>PosterCell</em>, and it can render any data which conforms <em>PosterPresentable</em> protocol. Let’s go ahead and create a separated struct which will contain presentation logic for show model and which we will pass to our cell instead of show model struct.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ShowPresentation</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">show</span><span class="p">:</span> <span class="kt">Show</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ShowPresentation</span><span class="p">:</span> <span class="kt">PosterPresentable</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">show</span><span class="o">.</span><span class="n">title</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">subtitle</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">guard</span>
            <span class="k">let</span> <span class="nv">nextEpisode</span> <span class="o">=</span> <span class="n">show</span><span class="o">.</span><span class="n">unwatched</span><span class="o">.</span><span class="n">first</span>
            <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
        <span class="k">return</span> <span class="s">"S</span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">season</span><span class="se">)</span><span class="s">E</span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">number</span><span class="se">)</span><span class="s"> </span><span class="se">\(</span><span class="n">nextEpisode</span><span class="o">.</span><span class="n">title</span><span class="se">)</span><span class="s">"</span>
    <span class="p">}</span>

    <span class="k">var</span> <span class="nv">poster</span><span class="p">:</span> <span class="kt">URL</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">show</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">poster</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>By extracting show model formatting logic into <em>ShowPresentation</em> struct, we fix the encapsulation problem when cell class responsible for formatting own data model. Another positive effect here is that we can easily cover <em>ShowPresentation</em> with Unit Testing to make sure it works correctly. So, let’s continue with implementing tests for our presentation logic.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ShowPresentationTests</span><span class="p">:</span> <span class="kt">XCTestCase</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">testShowPresentation</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">mockedImages</span> <span class="o">=</span> <span class="kt">Images</span><span class="p">(</span>
            <span class="nv">poster</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://image.tmdb.org/t/p/original/fbtaoynlPpENx3Ss2laC7wgqLIP.jpg"</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
            <span class="nv">banner</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://image.tmdb.org/t/p/original/fbtaoynlPpENx3Ss2laC7wgqLIP.jpg"</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
            <span class="nv">background</span><span class="p">:</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"https://image.tmdb.org/t/p/original/fbtaoynlPpENx3Ss2laC7wgqLIP.jpg"</span><span class="p">)</span><span class="o">!</span>
        <span class="p">)</span>

        <span class="k">let</span> <span class="nv">mockedEpisode</span> <span class="o">=</span> <span class="kt">Episode</span><span class="p">(</span>
            <span class="nv">title</span><span class="p">:</span> <span class="s">"The One Where Monica Gets A Roommate"</span><span class="p">,</span>
            <span class="nv">season</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nv">number</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">let</span> <span class="nv">mockedShow</span> <span class="o">=</span> <span class="kt">Show</span><span class="p">(</span>
            <span class="nv">title</span><span class="p">:</span> <span class="s">"Friends"</span><span class="p">,</span>
            <span class="nv">images</span><span class="p">:</span> <span class="n">mockedImages</span><span class="p">,</span>
            <span class="nv">unwatched</span><span class="p">:</span> <span class="p">[</span><span class="n">mockedEpisode</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">let</span> <span class="nv">presentation</span> <span class="o">=</span> <span class="kt">ShowPresentation</span><span class="p">(</span><span class="nv">show</span><span class="p">:</span> <span class="n">mockedShow</span><span class="p">)</span>
        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">presentation</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"Friends"</span><span class="p">)</span>
        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">presentation</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span>  <span class="s">"S1E1 The One Where Monica Gets A Roommate"</span><span class="p">)</span>
        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">presentation</span><span class="o">.</span><span class="n">poster</span><span class="o">.</span><span class="n">absoluteString</span><span class="p">,</span> <span class="s">"https://image.tmdb.org/t/p/original/fbtaoynlPpENx3Ss2laC7wgqLIP.jpg"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have a Unit Test which is checking the way of how our presentation struct formats the data. You might have more fields and more complex logic there. This Unit Test will keep you from breaking the presentation rules of your data in the future during refactoring or any other changes.</p>

<h4 id="conclusion">Conclusion</h4>
<p>Today we discussed how easily we can follow the Single Responsibility principle during UI development and how we can extract data presentation and formatting logic into testable and reusable pieces of code. We will continue the Unit Testing topic on my blog through the next posts. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
