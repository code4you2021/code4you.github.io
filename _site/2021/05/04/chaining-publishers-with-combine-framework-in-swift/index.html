<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Chaining publishers with Combine in Swift | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Chaining publishers with Combine in Swift" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Combine framework provides you a bunch of operators to map, filter, and chain asynchronous operations. This week I want to focus on the chaining asynchronous jobs using two main operators that the Combine framework provides us. We will learn how to use flatMap and switchToLatest operators to chain asynchronous tasks in a declarative way." />
<meta property="og:description" content="The Combine framework provides you a bunch of operators to map, filter, and chain asynchronous operations. This week I want to focus on the chaining asynchronous jobs using two main operators that the Combine framework provides us. We will learn how to use flatMap and switchToLatest operators to chain asynchronous tasks in a declarative way." />
<link rel="canonical" href="http://localhost:4000/2021/05/04/chaining-publishers-with-combine-framework-in-swift/" />
<meta property="og:url" content="http://localhost:4000/2021/05/04/chaining-publishers-with-combine-framework-in-swift/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/combine.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-05-04T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/combine.png" />
<meta property="twitter:title" content="Chaining publishers with Combine in Swift" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/05/04/chaining-publishers-with-combine-framework-in-swift/"},"url":"http://localhost:4000/2021/05/04/chaining-publishers-with-combine-framework-in-swift/","image":"http://localhost:4000/public/combine.png","author":{"@type":"Person","name":"Code4You"},"headline":"Chaining publishers with Combine in Swift","description":"The Combine framework provides you a bunch of operators to map, filter, and chain asynchronous operations. This week I want to focus on the chaining asynchronous jobs using two main operators that the Combine framework provides us. We will learn how to use flatMap and switchToLatest operators to chain asynchronous tasks in a declarative way.","dateModified":"2021-05-04T00:00:00+08:00","datePublished":"2021-05-04T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Chaining publishers with Combine in Swift</h2>
  <time datetime="2021-05-04T00:00:00+08:00" class="post-date">04 May 2021</time>
  <p>The Combine framework provides you a bunch of operators to map, filter, and chain asynchronous operations. This week I want to focus on the chaining asynchronous jobs using two main operators that the Combine framework provides us. We will learn how to use <em>flatMap</em> and <em>switchToLatest</em> operators to chain asynchronous tasks in a declarative way.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="chaining-basics-with-the-flatmap-operator">Chaining basics with the flatMap operator</h4>
<p>The <em>flatMap</em> operator allows us to take the result of one publisher, pass it to another and run the second publisher. We can use it to chain two different publishers. Let’s take a look at how we can use it.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">GithubService</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">JSONDecoder</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="kt">URLSession</span> <span class="o">=</span> <span class="o">.</span><span class="n">shared</span><span class="p">,</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">JSONDecoder</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="k">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">searchPublisher</span><span class="p">(</span><span class="n">matching</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Repo</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="c1">// some code here</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="kt">SearchViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">repos</span><span class="p">:</span> <span class="p">[</span><span class="kt">Repo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span> <span class="o">=</span> <span class="kt">GithubService</span><span class="p">()</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">query</span>
            <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> 
                <span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span> 
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we create the <em>SearchViewModel</em> class that conforms to <em>ObservableObject</em>. Here we define two properties query and repos. @<em>Published</em> property wrapper automatically provides a publisher for property and allows us to access it via projected value using <strong>$</strong> sign.</p>

<blockquote>
  <p>To learn more about designing API with Combine publishers, take a look at my <a href="/2021/04/07/designing-api-using-combine-framework/">“Designing API using Combine framework”</a> post.</p>
</blockquote>

<p>In the <em>SearchViewModel</em> initializer, we use the <em>flatMap</em> operator to pass the value of query publisher and generate a new search publisher using the provided query. Then we use the <em>assign</em> operator to save the result of the search operation in the repos property.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ContentView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@StateObject</span> <span class="k">var</span> <span class="nv">viewModel</span> <span class="o">=</span> <span class="kt">SearchViewModel</span><span class="p">()</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">NavigationView</span> <span class="p">{</span>
            <span class="kt">List</span> <span class="p">{</span>
                <span class="kt">TextField</span><span class="p">(</span><span class="s">"Query"</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="err">$</span><span class="n">viewModel</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
                <span class="kt">ForEach</span><span class="p">(</span><span class="n">viewModel</span><span class="o">.</span><span class="n">repos</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
                    <span class="kt">VStack</span><span class="p">(</span><span class="nv">alignment</span><span class="p">:</span> <span class="o">.</span><span class="n">leading</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">Text</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="o">.</span><span class="nf">font</span><span class="p">(</span><span class="o">.</span><span class="n">headline</span><span class="p">)</span>
                        <span class="k">if</span> <span class="k">let</span> <span class="nv">description</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">description</span> <span class="p">{</span>
                            <span class="kt">Text</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                                <span class="o">.</span><span class="nf">foregroundColor</span><span class="p">(</span><span class="o">.</span><span class="n">secondary</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="o">.</span><span class="nf">navigationTitle</span><span class="p">(</span><span class="s">"Search"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can use the <em>SearchViewModel</em> in our SwiftUI app to implement a GitHub repos search screen. Here we have a SwiftUI view that contains a text field for query terms and a list of results.</p>

<p><em>SearchViewModel</em> will make a network request as soon as the user types something in the query text field. Every new character in the text field generates a new API request. Usually, we want to delay requests till user typing. We can achieve this behavior by using <em>debounce</em> operator on query publisher in the <em>SearchViewModel</em>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">SearchViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">repos</span><span class="p">:</span> <span class="p">[</span><span class="kt">Repo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span> <span class="o">=</span> <span class="kt">GithubService</span><span class="p">()</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">query</span>
            <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> 
                <span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span> 
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <em>debounce</em> operator blocks the chain for a time interval that you provide and doesn’t emit any values in that period of time. It emits the latest value after the timeout that you provide. We can significantly reduce the number of network requests we make using <em>debounce</em> operator.</p>

<blockquote>
  <p>To learn more about the set of operators that the Combine framework provides us, take a look at my <a href="/2020/04/22/catching-errors-in-combine/">“Catching errors in Combine”</a> post.</p>
</blockquote>

<h4 id="advanced-chaining-with-switchtolatest-operator">Advanced chaining with switchToLatest operator</h4>
<p>Assume that you have a situation where a user types two queries in a sequence, but the network delays the first one, and the second one finishes earlier. The view represents the search result for the second request, but after a decent amount of time, the first query finishes, and the data appears on the screen by replacing the results of the second query.</p>

<p>Usually, we want to present the results of the latest query and ignore the previous attempts. We can’t achieve that with the <em>flatMap</em> operator, and especially for this case, the Combine framework provides us the <em>switchToLatest</em> operator.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">SearchViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">repos</span><span class="p">:</span> <span class="p">[</span><span class="kt">Repo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">private</span> <span class="k">let</span> <span class="nv">service</span> <span class="o">=</span> <span class="kt">GithubService</span><span class="p">()</span>

    <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="err">$</span><span class="n">query</span>
            <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="n">map</span> <span class="p">{</span> 
                <span class="k">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                    <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span>
            <span class="p">}</span>
            <span class="o">.</span><span class="nf">switchToLatest</span><span class="p">()</span>
            <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the example above, we refactored our <em>SearchViewModel</em> to use the <em>switchToLatest</em> operator. The <em>switchToLatest</em> operator is designed to work with a publisher that emits other publishers. That’s why we use the <em>map</em> operator to transform our publisher into the publisher that emits search publishers. Then we attach the <em>switchToLatest</em> operator flattening the stream of publishers and delivering results only from the latest one.</p>

<h4 id="conclusion">Conclusion</h4>
<p>This week we learned about two different ways of chaining asynchronous operations with the Combine framework. Usually, the <em>flatMap</em> operator is what you need to chain multiple operations. When you should do some work as a response to a user action, you should use the combination of <em>map</em> and <em>switchToLatest</em> operators to deliver the latest results. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
