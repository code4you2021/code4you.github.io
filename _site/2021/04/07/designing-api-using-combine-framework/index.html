<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Designing API using Combine framework | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Designing API using Combine framework" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Combine framework provides a declarative Swift API for processing values over time. It allows you to chain, transform and reduce multiple operations. This week we will learn how to design our APIs using the Combine framework to leverage all the data processing power that the framework provides us." />
<meta property="og:description" content="Combine framework provides a declarative Swift API for processing values over time. It allows you to chain, transform and reduce multiple operations. This week we will learn how to design our APIs using the Combine framework to leverage all the data processing power that the framework provides us." />
<link rel="canonical" href="http://localhost:4000/2021/04/07/designing-api-using-combine-framework/" />
<meta property="og:url" content="http://localhost:4000/2021/04/07/designing-api-using-combine-framework/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/combine.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-07T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/combine.png" />
<meta property="twitter:title" content="Designing API using Combine framework" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/04/07/designing-api-using-combine-framework/"},"url":"http://localhost:4000/2021/04/07/designing-api-using-combine-framework/","image":"http://localhost:4000/public/combine.png","author":{"@type":"Person","name":"Code4You"},"headline":"Designing API using Combine framework","description":"Combine framework provides a declarative Swift API for processing values over time. It allows you to chain, transform and reduce multiple operations. This week we will learn how to design our APIs using the Combine framework to leverage all the data processing power that the framework provides us.","dateModified":"2021-04-07T00:00:00+08:00","datePublished":"2021-04-07T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Designing API using Combine framework</h2>
  <time datetime="2021-04-07T00:00:00+08:00" class="post-date">07 Apr 2021</time>
  <p>Combine framework provides a declarative Swift API for processing values over time. It allows you to chain, transform and reduce multiple operations. This week we will learn how to design our APIs using the Combine framework to leverage all the data processing power that the framework provides us.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="future-and-deferred-publishers">Future and Deferred publishers</h4>
<p>The easiest way to integrate your asynchronous API with the Combine framework is to use <em>Future</em> publisher. All you need to do is provide closure that calls the completion handler whenever it finishes the job. Let’s take a look at the simple example.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">HealthService</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">HKHealthStore</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">authorize</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kt">Future</span> <span class="p">{</span> <span class="n">handler</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="nf">requestAuthorization</span><span class="p">(</span>
                <span class="nv">toShare</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">workout</span><span class="p">],</span> 
                <span class="nv">read</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">hr</span><span class="p">]</span>
            <span class="p">)</span> <span class="p">{</span> <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                    <span class="nf">handler</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">handler</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we wrap the old school HealthKit API with <em>Future</em> publisher. Inside the <em>Future</em> publisher, we call the asynchronous method of <em>HKHealthStore</em> to authorize the user. We deliver the result of the <em>HKHealthStore</em>’s authorize method using the handler of <em>Future</em> publisher.</p>

<p>The <em>Future</em> publisher has a few downsides, and one of them is the publisher’s eager nature. It means Combine will run the publisher as soon as you create it.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">health</span> <span class="o">=</span> <span class="kt">HealthService</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">authPublisher</span> <span class="o">=</span> <span class="n">health</span><span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>
</code></pre></div></div>

<p>In the example above, we create an instance of an authorization publisher but never subscribe to it. We expect that Combine will run the publisher later when we subscribe to it using a <em>sink</em> or <em>assign</em>, but it runs immediately. The Combine framework provides us the <em>Deferred</em> publisher that prevents these situations.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">HealthService</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">HKHealthStore</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">authorize</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kt">Deferred</span> <span class="p">{</span>
            <span class="kt">Future</span> <span class="p">{</span> <span class="n">handler</span> <span class="k">in</span>
                <span class="k">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="nf">requestAuthorization</span><span class="p">(</span>
                    <span class="nv">toShare</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">workout</span><span class="p">],</span> 
                    <span class="nv">read</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">hr</span><span class="p">]</span>
                <span class="p">)</span> <span class="p">{</span> <span class="n">success</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                        <span class="nf">handler</span><span class="p">(</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nf">handler</span><span class="p">(</span><span class="o">.</span><span class="nf">success</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can quickly wrap a <em>Future</em> publisher with a <em>Deferred</em> publisher to make it lazy. <em>Deferred</em> publisher runs only when we subscribe to it. Now we can use our new API and leverage all the power of declarative value processing.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">health</span> <span class="o">=</span> <span class="kt">HealthService</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">cancellables</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">health</span>
    <span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="s">"user authorized: </span><span class="se">\(</span><span class="nv">$0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancellables</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>To learn more about the set of operators that the Combine framework provides us, take a look at my <a href="/2020/04/22/catching-errors-in-combine/">“Catching errors in Combine”</a> post.</p>
</blockquote>

<h4 id="passthroughsubject">PassthroughSubject</h4>
<p><em>Future</em> publisher works excellent when you need to wrap the asynchronous task and deliver a single result. But what about the stream of values that we want to provide over time? We can’t do that with <em>Future</em> publisher because it finishes its work as soon as it delivers the first result. We can handle this case with <em>PassthroughSubject</em>.</p>

<p><em>PassthroughSubject</em> is a publisher that you can use to inject values into a stream by calling its <em>send</em> method. We will use <em>PassthroughSubject</em> to design the APIs that provide values through time. For example, it might be user location or user heart rate. These values appear over time.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">HealthService1</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">HKHealthStore</span><span class="p">()</span>

    <span class="kd">func</span> <span class="nf">heartRate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Double</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">subject</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Double</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">()</span>

        <span class="k">let</span> <span class="nv">query</span> <span class="o">=</span> <span class="kt">HKAnchoredObjectQuery</span><span class="p">(</span>
            <span class="nv">type</span><span class="p">:</span> <span class="kt">HKQuantityType</span><span class="o">.</span><span class="n">heartRate</span><span class="p">,</span>
            <span class="nv">predicate</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="nv">anchor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="nv">limit</span><span class="p">:</span> <span class="kt">HKObjectQueryNoLimit</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">query</span><span class="p">,</span> <span class="n">newSamples</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                <span class="n">subject</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">newSamples</span> <span class="o">=</span> <span class="n">newSamples</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">HKQuantitySample</span><span class="p">]</span> <span class="p">??</span> <span class="p">[]</span>
                <span class="k">let</span> <span class="nv">hr</span> <span class="o">=</span> <span class="n">newSamples</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="nf">doubleValue</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">bpm</span><span class="p">())</span> <span class="p">}</span>
                <span class="n">subject</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="n">hr</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">subject</span><span class="o">.</span><span class="nf">handleEvents</span><span class="p">(</span>
            <span class="nv">receiveSubscription</span><span class="p">:</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span> <span class="k">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">},</span>
            <span class="nv">receiveCancel</span><span class="p">:</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="nf">stop</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, we use the subject’s <em>send</em> method to emit values that we obtain from a closure-based handler of <em>HKAnchoredObjectQuery</em>. <em>HKAnchoredObjectQuery</em> runs forever. That’s why we use the <em>handleEvents</em> operator to provide additional logic to handle the publisher’s lifecycle. We want to start the query only when we have a subscription and stop it immediately when the subscription is canceled.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">cancellables</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">health</span>
    <span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">authorized</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Double</span><span class="p">],</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">authorized</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">health</span><span class="o">.</span><span class="nf">heartRate</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kt">Empty</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span>
    <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="nf">print</span><span class="p">(</span><span class="s">"user authorized: </span><span class="se">\(</span><span class="nv">$0</span><span class="se">)</span><span class="s">"</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancellables</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="conclusion">Conclusion</h4>
<p>Combine provides us a straightforward and friendly way to handle asynchronous operations. We need to design our own APIs using the Combine to leverage the powerful operators that it gives us. We can model complex operation chains using a declarative approach and tools like <em>Future</em> and <em>PassthroughSubject</em>. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
