<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Building custom Combine operators in Swift | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Building custom Combine operators in Swift" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Combine looks like a very sophisticated framework and provides you all the needed things you might need to process your data. It comes with many valuable operators like map, filter, and reduce. This week we will learn how to build new operators that we might miss from the default package." />
<meta property="og:description" content="Combine looks like a very sophisticated framework and provides you all the needed things you might need to process your data. It comes with many valuable operators like map, filter, and reduce. This week we will learn how to build new operators that we might miss from the default package." />
<link rel="canonical" href="http://localhost:4000/2021/04/28/building-custom-combine-operators-in-swift/" />
<meta property="og:url" content="http://localhost:4000/2021/04/28/building-custom-combine-operators-in-swift/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/combine.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-28T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/combine.png" />
<meta property="twitter:title" content="Building custom Combine operators in Swift" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/04/28/building-custom-combine-operators-in-swift/"},"url":"http://localhost:4000/2021/04/28/building-custom-combine-operators-in-swift/","image":"http://localhost:4000/public/combine.png","author":{"@type":"Person","name":"Code4You"},"headline":"Building custom Combine operators in Swift","description":"Combine looks like a very sophisticated framework and provides you all the needed things you might need to process your data. It comes with many valuable operators like map, filter, and reduce. This week we will learn how to build new operators that we might miss from the default package.","dateModified":"2021-04-28T00:00:00+08:00","datePublished":"2021-04-28T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Building custom Combine operators in Swift</h2>
  <time datetime="2021-04-28T00:00:00+08:00" class="post-date">28 Apr 2021</time>
  <p>Combine looks like a very sophisticated framework and provides you all the needed things you might need to process your data. It comes with many valuable operators like map, filter, and reduce. This week we will learn how to build new operators that we might miss from the default package.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<p>Rather than implementing the <em>Publisher</em> protocol yourself, you can create your own operator using composition and several standard operators and publishers provided by the Combine framework. Let’s start with the simplest one.</p>

<h4 id="replace-error-or-empty-with-value">Replace error or empty with value</h4>
<p>The Combine framework has <em>replaceEmpty</em> and <em>replaceError</em> operators that we can use to inject the value into an empty publisher or replace the error with a value. I need both of them very often, and instead of typing these two operators every time, we can create a new one that combines them.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">replaceErrorOrEmpty</span><span class="p">(</span><span class="n">with</span> <span class="nv">output</span><span class="p">:</span> <span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span>
            <span class="o">.</span><span class="nf">replaceEmpty</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">output</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">output</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we can create an extension for <em>Publisher</em> type in a straightforward way and add the functionality we need by composing other operators. Now we can use the new operator as we use standard ones.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">Reducer</span> <span class="p">{</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">environment</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">fetch</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">environment</span><span class="o">.</span><span class="n">healthService</span>
            <span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>
            <span class="o">.</span><span class="nf">replaceErrorOrEmpty</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">AppAction</span><span class="o">.</span><span class="n">setAuthStatus</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>To learn more about the set of operators that the Combine framework provides us, take a look at my <a href="/2020/04/22/catching-errors-in-combine/">“Catching errors in Combine”</a> post.</p>
</blockquote>

<h4 id="finish-on-fail">Finish on fail</h4>
<p>Another helpful operator might be finish on fail. There are different circumstances where you don’t need to handle the failure and want to finish silently. There is not standard operator for that in the Combine framework, but we can quickly achieve it by using the <em>catch</em> operator and <em>Empty</em> publisher.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">finishOnFail</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span>
            <span class="o">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span> <span class="kt">Empty</span><span class="p">()</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have another extension on <em>Publisher</em> type that adds an opportunity to finish the publisher without emitting an error. I usually use the <em>finishOnFail</em> operator in conjunction with the <em>Merge</em> publisher. For example, on every app launch, I start a network request to fetch the latest data, but at the same time, I fetch and display locally cached data. In this case, I don’t worry if my network request fails or not because I have the data to show.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">newsReducer</span><span class="p">(</span>
    <span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span>
    <span class="nv">action</span><span class="p">:</span> <span class="kt">Action</span><span class="p">,</span>
    <span class="nv">environment</span><span class="p">:</span> <span class="kt">Environment</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Action</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">fetch</span><span class="p">:</span>
        <span class="k">return</span> <span class="kt">Publishers</span><span class="o">.</span><span class="kt">Merge</span><span class="p">(</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">newsService</span><span class="o">.</span><span class="nf">fetchCachedNews</span><span class="p">(),</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">newsService</span><span class="o">.</span><span class="nf">fetchRemoteNews</span><span class="p">()</span>
                <span class="o">.</span><span class="nf">finishOnFail</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">Action</span><span class="o">.</span><span class="n">setNews</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="k">default</span><span class="p">:</span> 
        <span class="k">return</span> <span class="kt">Empty</span><span class="p">()</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="catch-result">Catch result</h4>
<p>OK, we know how to ignore errors, but we should at least handle them. In many cases, an error can be a part of the app state that why we should not ignore it. Instead, we have to store and display it correctly. Let’s first build an operator which we can use to wrap the value and error into a <em>Result</em> type that the publisher emits instead of plain value.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">catchResult</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">self</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">Result</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
            <span class="o">.</span><span class="k">catch</span> <span class="p">{</span> <span class="kt">Just</span><span class="p">(</span><span class="kt">Result</span><span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="nv">$0</span><span class="p">))</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Assume that we have a single state container that stores the whole app state. There is a dedicated field defining the state of an authorization request as an instance of <em>Result</em> enum. Let’s see how it might look in code.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">State</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">auth</span><span class="p">:</span> <span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span>
<span class="p">}</span>

<span class="kd">enum</span> <span class="kt">Action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">fetchAuth</span>
    <span class="k">case</span> <span class="nf">setAuth</span><span class="p">(</span><span class="kt">Result</span><span class="o">&lt;</span><span class="kt">Bool</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">authReducer</span><span class="p">(</span>
    <span class="nv">state</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">State</span><span class="p">,</span>
    <span class="nv">action</span><span class="p">:</span> <span class="kt">Action</span><span class="p">,</span>
    <span class="nv">environment</span><span class="p">:</span> <span class="kt">Environment</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Action</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">fetchAuth</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">environment</span><span class="o">.</span><span class="n">service</span>
            <span class="o">.</span><span class="nf">authorize</span><span class="p">()</span>
            <span class="o">.</span><span class="nf">catchResult</span><span class="p">()</span>
            <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">Action</span><span class="o">.</span><span class="n">setAuth</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">setAuth</span><span class="p">(</span><span class="k">let</span> <span class="nv">result</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="kt">Empty</span><span class="p">()</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Side effects returned by reducers should never fail. Even if it fails under the hood, it should emit an action that defines a failure. It is a perfect use case for our new <em>catchResult</em> operator.</p>

<blockquote>
  <p>If you are not familiar with the concept of a single source of truth, take a look at my dedicated series of <a href="/2019/09/18/redux-like-state-container-in-swiftui/">“Redux-like state container in SwiftUI”</a> posts.</p>
</blockquote>

<h4 id="conclusion">Conclusion</h4>
<p>The Combine framework is a great tool to handle asynchronous operations in your app. It provides you with tons of operators to transform your data, but it is also effortless to extend it using the composition of standard operators that we learned today. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
