<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Building networking layer using functions | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Building networking layer using functions" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This week I want to talk about building a networking layer in Swift using Functional programming. Functional programming is a way of making programs using pure functions and function composition. Let’s see how we can use it to build a flexible and composable network layer." />
<meta property="og:description" content="This week I want to talk about building a networking layer in Swift using Functional programming. Functional programming is a way of making programs using pure functions and function composition. Let’s see how we can use it to build a flexible and composable network layer." />
<link rel="canonical" href="http://localhost:4000/2020/01/08/building-networking-layer-using-functions/" />
<meta property="og:url" content="http://localhost:4000/2020/01/08/building-networking-layer-using-functions/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/networking.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-08T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/networking.png" />
<meta property="twitter:title" content="Building networking layer using functions" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/01/08/building-networking-layer-using-functions/"},"url":"http://localhost:4000/2020/01/08/building-networking-layer-using-functions/","image":"http://localhost:4000/public/networking.png","author":{"@type":"Person","name":"Code4You"},"headline":"Building networking layer using functions","description":"This week I want to talk about building a networking layer in Swift using Functional programming. Functional programming is a way of making programs using pure functions and function composition. Let’s see how we can use it to build a flexible and composable network layer.","dateModified":"2020-01-08T00:00:00+08:00","datePublished":"2020-01-08T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Building networking layer using functions</h2>
  <time datetime="2020-01-08T00:00:00+08:00" class="post-date">08 Jan 2020</time>
  <p>This week I want to talk about building a networking layer in Swift using <em>Functional programming</em>. <em>Functional programming</em> is a way of making programs using <em>pure functions and function composition</em>. Let’s see how we can use it to build a flexible and composable network layer.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<p>Usually, Swift developers use the <em>Protocol-Oriented</em> style of programming to build any abstractions like the networking layer. In most of the cases, protocols generate more boilerplate than needed. Let’s instead model our networking layer using a pure function and function composition.</p>

<h4 id="pure-functions">Pure functions</h4>
<p>Pure functions calculate output using input and don’t affect or rely on any state outside itself. It means pure function takes an argument to transform and return a new value. Here is a very simple example of a pure function that takes two arguments, sums them, and returns a new value.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">add</span><span class="p">(</span><span class="n">_</span> <span class="nv">a</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">_</span> <span class="nv">b</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We know how to use pure functions. Let’s model our networking layer using a function. Usually, we need a way of transforming URL request into raw data and HTTP response.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">typealias</span> <span class="kt">Networking</span> <span class="o">=</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="kt">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">),</span> <span class="kt">Error</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Networking function is a function that accepts a request and returns an error or response. We want to do our networking asynchronously, and we can achieve it by using the <em>Combine</em> framework. Let’s change our networking function definition to use <em>Publisher</em> instead of the Result type.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">typealias</span> <span class="kt">Networking</span> <span class="o">=</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">),</span> <span class="kt">Error</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>You should be familiar with this type alias. <em>URLSession</em> class has a similar type for its <em>dataTaskPublisher</em> method. We can create an extension for <em>URLSession</em> to create a new method that <em>“conforms”</em> to our <em>Networking</em> type.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">URLSession</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">erasedDataTaskPublisher</span><span class="p">(</span>
        <span class="k">for</span> <span class="nv">request</span><span class="p">:</span> <span class="kt">URLRequest</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span><span class="p">),</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nf">dataTaskPublisher</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span>
            <span class="o">.</span><span class="n">mapError</span> <span class="p">{</span> <span class="nv">$0</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s see how we can inject our networking function into some service layer objects which use the network to load and decode domain specific objects.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">FeedService</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">networking</span><span class="p">:</span> <span class="kt">Networking</span>

    <span class="kd">func</span> <span class="nf">fetchFeed</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Feed</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="nf">networking</span><span class="p">(</span><span class="o">.</span><span class="nf">feed</span><span class="p">())</span>
            <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">data</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="kt">Feed</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">decoder</span><span class="p">:</span> <span class="kt">JSONDecoder</span><span class="p">())</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">feedService</span> <span class="o">=</span> <span class="kt">FeedService</span><span class="p">(</span><span class="nv">networking</span><span class="p">:</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">erasedDataTaskPublisher</span><span class="p">)</span>
<span class="n">feedService</span><span class="o">.</span><span class="nf">fetchFeed</span><span class="p">()</span>
</code></pre></div></div>

<p>One of the benefits of this approach is the ability to replace our real-world networking function with any mock implementation. Let’s see how we can do that.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">mockNetworking</span><span class="p">(</span>
    <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">(),</span>
    <span class="nv">response</span><span class="p">:</span> <span class="kt">URLResponse</span> <span class="o">=</span> <span class="o">.</span><span class="nf">init</span><span class="p">()</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Networking</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
        <span class="kt">Just</span><span class="p">((</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">response</span><span class="p">:</span> <span class="n">response</span><span class="p">))</span>
            <span class="o">.</span><span class="nf">setFailureType</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Error</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">mockedFeedService</span> <span class="o">=</span> <span class="kt">FeedService</span><span class="p">(</span><span class="nv">networking</span><span class="p">:</span> <span class="nf">mockNetworking</span><span class="p">())</span>
</code></pre></div></div>

<p>In the example above, we use one of the powerful techniques from functional programming called <strong>partial function application</strong>. Partial application refers to the process of fixing a number of arguments to a function, producing another function of smaller arity. In other words, we create a function that returns another function that captures arguments and can use them in its own body.</p>

<h4 id="function-composition">Function composition</h4>
<p>Assume that you need to add an OAuth token header to every request that you run, but you don’t want to pass it every time while creating a request.</p>

<p>We can use function composition to solve our problem. Function composition is a way of generating new functions by chaining two or more other functions.</p>

<ol>
  <li>We need a function that will modify our requests by adding OAuth token to the headers.</li>
  <li>We need a new function that composes a header modifier function with our old networking function.</li>
</ol>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">tokenRequestModifier</span><span class="p">(</span><span class="n">_</span> <span class="nv">token</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">URLRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URLRequest</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="n">request</span> <span class="k">in</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="n">request</span><span class="o">.</span><span class="nf">addValue</span><span class="p">(</span><span class="s">"Bearer </span><span class="se">\(</span><span class="n">token</span><span class="se">)</span><span class="s">"</span><span class="p">,</span> <span class="nv">forHTTPHeaderField</span><span class="p">:</span> <span class="s">"Authorization"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the example above, we have <em>tokenRequestModifier</em> function. Again, we use partial application techniques to fix the token parameter and generate a new request modifier function. Now we can compose it with our networking function to create a brand new authorized networking function.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="n">compose</span><span class="o">&lt;</span><span class="kt">A</span><span class="p">,</span> <span class="kt">B</span><span class="p">,</span> <span class="kt">C</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">f</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">B</span><span class="p">,</span>
    <span class="n">_</span> <span class="nv">g</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">B</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">C</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">C</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="nf">g</span><span class="p">(</span><span class="nf">f</span><span class="p">(</span><span class="nv">$0</span><span class="p">))</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">token</span> <span class="o">=</span> <span class="kt">UserDefaults</span><span class="o">.</span><span class="n">standard</span><span class="o">.</span><span class="nf">string</span><span class="p">(</span><span class="nv">forKey</span><span class="p">:</span> <span class="s">"token"</span><span class="p">)</span> <span class="p">??</span> <span class="s">""</span>
<span class="k">let</span> <span class="nv">authorizedNetworking</span> <span class="o">=</span> <span class="nf">compose</span><span class="p">(</span>
    <span class="nf">tokenRequestModifier</span><span class="p">(</span><span class="n">token</span><span class="p">),</span>
    <span class="n">networking</span>
<span class="p">)</span>

<span class="nf">authorizedNetworking</span><span class="p">(</span><span class="o">.</span><span class="nf">feed</span><span class="p">())</span>
</code></pre></div></div>

<p>Here we compose two functions: <em>tokenRequestModifier</em> and <em>networking</em> to create a brand new authorized networking function. Function composition allows us to run <em>tokenRequestModifier</em> before every networking request, which we run via authorized networking function.</p>

<h4 id="conclusion">Conclusion</h4>
<p>Today we talked about building a networking layer in a very functional way. I’m not saying that protocols are bad or something similar. Protocols are awesome when you need to build a huge hierarchy of types like collections that we have in Swift standard library.</p>

<p>But usually, we have mocked and production implementation, and this is the case where functions are more than enough. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
