<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Catching errors in Combine | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Catching errors in Combine" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The Combine framework provides a declarative Swift API for processing values over time. It is another excellent framework that released side-by-side with SwiftUI. I already covered it multiple times on my blog, but today I want to talk about one of the key aspects of data processing. Today we will learn how to handle errors during data processing using the Combine framework." />
<meta property="og:description" content="The Combine framework provides a declarative Swift API for processing values over time. It is another excellent framework that released side-by-side with SwiftUI. I already covered it multiple times on my blog, but today I want to talk about one of the key aspects of data processing. Today we will learn how to handle errors during data processing using the Combine framework." />
<link rel="canonical" href="http://localhost:4000/2020/04/22/catching-errors-in-combine/" />
<meta property="og:url" content="http://localhost:4000/2020/04/22/catching-errors-in-combine/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/catch.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-22T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/catch.png" />
<meta property="twitter:title" content="Catching errors in Combine" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/04/22/catching-errors-in-combine/"},"url":"http://localhost:4000/2020/04/22/catching-errors-in-combine/","image":"http://localhost:4000/public/catch.png","author":{"@type":"Person","name":"Code4You"},"headline":"Catching errors in Combine","description":"The Combine framework provides a declarative Swift API for processing values over time. It is another excellent framework that released side-by-side with SwiftUI. I already covered it multiple times on my blog, but today I want to talk about one of the key aspects of data processing. Today we will learn how to handle errors during data processing using the Combine framework.","dateModified":"2020-04-22T00:00:00+08:00","datePublished":"2020-04-22T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Catching errors in Combine</h2>
  <time datetime="2020-04-22T00:00:00+08:00" class="post-date">22 Apr 2020</time>
  <p>The Combine framework provides a declarative <em>Swift API</em> for processing values over time. It is another excellent framework that released side-by-side with SwiftUI. I already covered it multiple times on my blog, but today I want to talk about one of the key aspects of data processing. Today we will learn how to handle errors during data processing using the Combine framework.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="the-lifecycle-of-publisher">The lifecycle of publisher</h4>
<p>We use publishers to emit values over time. In the end, the publisher can finish its work by sending the completion event or fail with an error. Neither after completion nor after failure, the publisher can not emit new values. Let’s take a look at the typical use-case that we might have in our apps.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">SwiftUI</span>

<span class="kd">struct</span> <span class="kt">SearchView</span><span class="p">:</span> <span class="kt">View</span> <span class="p">{</span>
    <span class="kd">@ObservedObject</span> <span class="k">var</span> <span class="nv">store</span><span class="p">:</span> <span class="kt">SearchStore</span>

    <span class="k">var</span> <span class="nv">body</span><span class="p">:</span> <span class="kd">some</span> <span class="kt">View</span> <span class="p">{</span>
        <span class="kt">NavigationView</span> <span class="p">{</span>
            <span class="kt">List</span> <span class="p">{</span>
                <span class="kt">TextField</span><span class="p">(</span><span class="s">"type something..."</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="err">$</span><span class="n">store</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
                <span class="kt">ForEach</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">repos</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="p">\</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">repo</span> <span class="k">in</span>
                    <span class="kt">Text</span><span class="p">(</span><span class="n">repo</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="o">.</span><span class="nf">navigationBarTitle</span><span class="p">(</span><span class="s">"Search"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the example above, we have a view that allows users to enter a keyword and the list that renders search results. We use a store object to bind a query and repos array that holds search results. The main goal of the store object is fetching repos matching the query using Github API.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">SearchStore</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="k">var</span> <span class="nv">query</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">repos</span><span class="p">:</span> <span class="p">[</span><span class="kt">Repo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancellable</span><span class="p">:</span> <span class="kt">AnyCancellable</span><span class="p">?</span>

    <span class="nf">init</span><span class="p">(</span><span class="nv">service</span><span class="p">:</span> <span class="kt">GithubService</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cancellable</span> <span class="o">=</span> <span class="err">$</span><span class="n">query</span>
            <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">service</span><span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">())</span>
            <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
                <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
                    <span class="k">switch</span> <span class="n">completion</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Error </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">case</span> <span class="o">.</span><span class="nv">finished</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="s">"Publisher is finished"</span><span class="p">)</span>
                    <span class="p">}</span>
            <span class="p">},</span>
                <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">repos</span> <span class="o">=</span> <span class="nv">$0</span> <span class="p">}</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I don’t want to produce too many requests as user types a query. That’s why I debounce it for 500ms. It means the publisher will wait at least 500ms whenever the user stops typing and then publish a value. Then I can use a <em>flatMap</em> operator to run a search request using a query. In the end, I use the <em>sink</em> subscriber to assign search results to a store variable. As soon as published variables change, SwiftUI will update the view to respect new data.</p>

<blockquote>
  <p>To learn more about store concept, take a look at my <a href="/2019/09/04/modeling-app-state-using-store-objects-in-swiftui/">“Modeling app state using Store objects in SwiftUI”</a> post.</p>
</blockquote>

<p>We have one problem here, whenever the publisher fails with an error, nothing will happen in the view. <em>Sink</em> subscriber will just print the message in the console.</p>

<h4 id="replace-error-with-the-value">Replace error with the value</h4>
<p>Publishers provide us a few ways to handle errors in the chain. Let’s start with the easiest one. Every publisher that can fail allows us to replace the error with some default value using <em>replaceError</em> operator. Let’s take a look at how we can use it.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span><span class="nv">service</span><span class="p">:</span> <span class="kt">GithubService</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">query</span>
        <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">service</span><span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
        <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span>
        <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">())</span>
        <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, I have inserted <em>replaceError</em> operator with an empty array. Publisher will replace any error that might occur with an empty array and then terminate. The downside here is that the publisher completes its work after an error. It means our binding will not process new values. The user will type further queries, but nothing will happen. Let’s see how we can fix that.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span><span class="nv">service</span><span class="p">:</span> <span class="kt">GithubService</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">query</span>
        <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> 
            <span class="n">service</span>
                <span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span> 
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">())</span>
        <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To keep your publisher alive, you have to handle all errors outside of the main chain. We can fix it by moving <em>replaceError</em> operator inside the <em>flatMap</em>. As you can see, the publisher inside the <em>flatMap</em> replaces an error with a value and then terminate its work. The main chain is still alive and emits new values.</p>

<h4 id="retry-operator">Retry operator</h4>
<p>Another useful operator that can help to solve an issue during value processing is <em>retry</em>. <em>Retry</em> operator tries to process the value again and again as many times as you specify.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span><span class="nv">service</span><span class="p">:</span> <span class="kt">GithubService</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">query</span>
        <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span>
            <span class="n">service</span>
                <span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">retry</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">.</span><span class="nf">replaceError</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="p">[])</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">())</span>
        <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, I ask the publisher to retry three times before replacing an error with an empty array.</p>

<h4 id="catch-operator">Catch operator</h4>
<p>Both retry and replace error operators are built on top of the <em>catch</em> operator. The <em>catch</em> operator allows us to replace a failed publisher with a new one. After that, the chain will use the new publisher to emit values.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span><span class="nv">service</span><span class="p">:</span> <span class="kt">GithubService</span><span class="p">)</span> <span class="p">{</span>
    <span class="err">$</span><span class="n">query</span>
        <span class="o">.</span><span class="nf">debounce</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="nf">seconds</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="nv">scheduler</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span>
            <span class="n">service</span>
                <span class="o">.</span><span class="nf">searchPublisher</span><span class="p">(</span><span class="nv">matching</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
                <span class="o">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">error</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Repo</span><span class="p">],</span> <span class="kt">Never</span><span class="o">&gt;</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="k">is</span> <span class="kt">URLError</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kt">Just</span><span class="p">([])</span>
                            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="kt">Empty</span><span class="p">(</span><span class="nv">completeImmediately</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
                            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
                    <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">())</span>
        <span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">on</span><span class="p">:</span> <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="p">)</span>
        <span class="o">.</span><span class="nf">assign</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="o">&amp;</span><span class="err">$</span><span class="n">repos</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another great thing about the <em>catch</em> operator is the opportunity to access the error and return a new publisher after inspecting the error.</p>

<h4 id="conclusion">Conclusion</h4>
<p>The Combine is the framework that I use in all of my apps. It has a high performance and friendly <em>Swift API</em>. Sometimes it is hard to debug errors in the Combine publisher chains. I hope this post gave you more information on the publisher’s lifecycle and explained to you how to catch the errors. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
