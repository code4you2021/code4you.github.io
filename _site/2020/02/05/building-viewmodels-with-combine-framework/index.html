<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="keywords" content="swift ios development apple watch iphone ipad swiftui macos uikit dev wwdc tutorial guide redux tea state container" />

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Building ViewModels with Combine framework | Code4You</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Building ViewModels with Combine framework" />
<meta name="author" content="Code4You" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="One of my first posts on this blog was about using the ViewModel pattern in iOS apps. I’m still using this concept in some old school UIKit projects. But I think it’s time to remaster that post. This week we will talk about building reactive ViewModels using Combine framework." />
<meta property="og:description" content="One of my first posts on this blog was about using the ViewModel pattern in iOS apps. I’m still using this concept in some old school UIKit projects. But I think it’s time to remaster that post. This week we will talk about building reactive ViewModels using Combine framework." />
<link rel="canonical" href="http://localhost:4000/2020/02/05/building-viewmodels-with-combine-framework/" />
<meta property="og:url" content="http://localhost:4000/2020/02/05/building-viewmodels-with-combine-framework/" />
<meta property="og:site_name" content="Code4You" />
<meta property="og:image" content="http://localhost:4000/public/viewmodel.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-02-05T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/public/viewmodel.png" />
<meta property="twitter:title" content="Building ViewModels with Combine framework" />
<script type="application/ld+json">
{"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/02/05/building-viewmodels-with-combine-framework/"},"url":"http://localhost:4000/2020/02/05/building-viewmodels-with-combine-framework/","image":"http://localhost:4000/public/viewmodel.png","author":{"@type":"Person","name":"Code4You"},"headline":"Building ViewModels with Combine framework","description":"One of my first posts on this blog was about using the ViewModel pattern in iOS apps. I’m still using this concept in some old school UIKit projects. But I think it’s time to remaster that post. This week we will talk about building reactive ViewModels using Combine framework.","dateModified":"2020-02-05T00:00:00+08:00","datePublished":"2020-02-05T00:00:00+08:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <link rel="stylesheet" href="/styles.css">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="Code4You" href="/feed.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <nav>
          <h1 class="masthead-title">
            <a href="/" title="Home">Code4You</a>
          </h1>
          <div>
            <a href="/categories" title="Categories">Categories</a>
            <a href="/archive" title="Archive">Archive</a>
            <a href="/feed.xml" title="Feed">Feed</a>
          </div>
        </nav>
      </header>

      <main>
        <article class="post">
  <h2 class="post-title">Building ViewModels with Combine framework</h2>
  <time datetime="2020-02-05T00:00:00+08:00" class="post-date">05 Feb 2020</time>
  <p>One of my first posts on this blog was about using the ViewModel pattern in iOS apps. I’m still using this concept in some old school UIKit projects. But I think it’s time to remaster that post. This week we will talk about building reactive ViewModels using Combine framework.</p>

<!-- <div class="ads">
    <span>
        Why don’t more iOS apps use voice? Machine learning for voice is hard, and using Siri is clunky and rigid. So we open-sourced an iOS library (also Android, Node, Python, & React Native), and built a no-code web tool to make custom wake words, speech recognizers, and AI voices—for all devs! <a href="https://www.spokestack.io/?utm_source=swiftui_weekly&utm_medium=email&utm_campaign=maker_launch_PAID">Try it for free.</a>
    </span>
</div> -->

<h4 id="what-is-viewmodel">What is ViewModel?</h4>
<p>ViewModel is a layer between your view and data. ViewModels usually fetch the data using service objects, format it, and provide a formatted version to your view.</p>

<blockquote>
  <p>You can check <a href="/2018/01/11/mastering-mvvm-on-ios/">my old post about MVVM</a> if you need more information about the pattern itself.</p>
</blockquote>

<h4 id="apple-started-promoting-mvvm">Apple started promoting MVVM</h4>
<p>I noticed an interesting thing when Apple moved the <em>ObservableObject</em> protocol to the Combine framework. It looks like Apple began promoting the MVVM pattern. Let’s take a look at the <em>ObservableObject</em> protocol to understand what’s going on there.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// A type of object with a publisher that emits before the object has changed.</span>
<span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">ObservableObject</span> <span class="p">:</span> <span class="kt">AnyObject</span> <span class="p">{</span>

    <span class="c1">/// The type of publisher that emits before the object has changed.</span>
    <span class="kd">associatedtype</span> <span class="kt">ObjectWillChangePublisher</span> <span class="p">:</span> <span class="kt">Publisher</span> <span class="o">=</span> <span class="kt">ObservableObjectPublisher</span> <span class="k">where</span> <span class="k">Self</span><span class="o">.</span><span class="kt">ObjectWillChangePublisher</span><span class="o">.</span><span class="kt">Failure</span> <span class="o">==</span> <span class="kt">Never</span>

    <span class="c1">/// A publisher that emits before the object has changed.</span>
    <span class="k">var</span> <span class="nv">objectWillChange</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="kt">ObjectWillChangePublisher</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>ObservableObject</em> protocol has the only one requirement, a publisher that emits before the object changes. Let’s write our first ViewModel that conforms to <em>ObservableObject</em> protocol.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PostsViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">objectWillChange</span> <span class="o">=</span> <span class="kt">PassthroughSubject</span><span class="o">&lt;</span><span class="kt">Void</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">()</span>

    <span class="kd">private</span> <span class="p">(</span><span class="k">set</span><span class="p">)</span> <span class="k">var</span> <span class="nv">posts</span><span class="p">:</span> <span class="p">[</span><span class="kt">Post</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// fetch posts</span>
        <span class="n">objectWillChange</span><span class="o">.</span><span class="nf">send</span><span class="p">()</span>
        <span class="c1">// assign new data to the posts variable</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have the ViewModel that fetches posts, stores them in the variable, and emits a notification via <em>objectWillChange</em> publisher. Let’s take a look at a sample <em>ViewController</em> that uses this ViewModel.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PostsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">PostsViewModel</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancellables</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="nf">bindViewModel</span><span class="p">()</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="nf">fetch</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">bindViewModel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="n">objectWillChange</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="k">self</span><span class="o">.</span><span class="nf">renderPosts</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">viewModel</span><span class="o">.</span><span class="n">posts</span><span class="p">)</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancellables</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we have <em>PostsViewController</em> that starts observing changes in ViewModel and then ask ViewModel to fetch data. As soon as ViewModel fetches data, it emits, and <em>ViewController</em> calls renderPosts function that displays downloaded posts.</p>

<h4 id="published-property-wrapper">Published property wrapper</h4>
<p>We can go further by using @<em>Published</em> property wrapper. @<em>Published</em> property wrapper allows us to wrap any property with the publisher that emits the current value whenever the property changes.</p>

<p>Moreover, you even don’t need to define <em>objectWillChange</em> publisher when you use @<em>Published</em> property wrapper. Swift compiler will <strong>automatically synthesize</strong> the <em>objectWillChange</em>, and it will emit whenever any @<em>Published</em> property changes. Let’s take a look at the refactored version of our ViewModel that uses @<em>Published</em> property wrapper.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PostsViewModel</span><span class="p">:</span> <span class="kt">ObservableObject</span> <span class="p">{</span>
    <span class="kd">@Published</span> <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">posts</span><span class="p">:</span> <span class="p">[</span><span class="kt">Post</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// fetch posts and assign them to `posts` variable</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see in the example above, we don’t need to send a value manually to <em>objectWillChange</em> publisher — all the work synthesized by the Swift compiler. And we can keep the same implementation of <em>PostsViewController</em>.</p>

<p>As I said before, @<em>Published</em> property wrapper wraps our property with a publisher. Let’s take a look at how we can use it in our <em>PostsViewController</em>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PostsViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">viewModel</span><span class="p">:</span> <span class="kt">PostsViewModel</span>
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">cancellables</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">AnyCancellable</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="nf">bindViewModel</span><span class="p">()</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="nf">fetch</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">bindViewModel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">viewModel</span><span class="o">.</span><span class="err">$</span><span class="n">posts</span>
            <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="k">in</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">renderPosts</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
            <span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">cancellables</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here we have a refactored version of our <em>PostsViewController</em>. Please take a look at how we changed <em>bindViewModel</em> function. It subscribes to <em>$posts</em> now, and it allows us to update our view only when specific properties change. You will see the benefits as soon as your ViewModel has more and more fields which can affect the view.</p>

<blockquote>
  <p>Apple also mentioned ViewModels during <a href="https://developer.apple.com/wwdc19/233">“Mastering Xcode Previews” session on WWDC 19</a>.</p>
</blockquote>

<h4 id="conclusion">Conclusion</h4>
<p>We can easily implement the very same logic using <em>RxSwift</em>, <em>ReactiveSwift</em>, or any other reactive framework like <em>Bond</em>. But I feel like <em>MVVM</em> is going to be a default choice in architecting iOS apps. At least now, when Apple provides us all the needed tools to build it out of the box. I hope you enjoy the post. Feel free to follow me on <a href="https://twitter.com/mecid">Twitter</a> and ask your questions related to this post. Thanks for reading, and see you next week!</p>

</article>


<aside class="related">
  <h4>Recent posts</h4>
  <ul class="related-posts">
    
      <li>
        <a title="Custom accessibility content in SwiftUI" href="/2021/10/06/custom-accessibility-content-in-swiftui/">
          Custom accessibility content in SwiftUI
          <small><time datetime="2021-10-06T00:00:00+08:00">06 Oct 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Audio graphs in SwiftUI" href="/2021/09/29/audio-graphs-in-swiftui/">
          Audio graphs in SwiftUI
          <small><time datetime="2021-09-29T00:00:00+08:00">29 Sep 2021</time></small>
        </a>
      </li>
    
      <li>
        <a title="Accessibility focus in SwiftUI" href="/2021/09/23/accessibility-focus-in-swiftui/">
          Accessibility focus in SwiftUI
          <small><time datetime="2021-09-23T00:00:00+08:00">23 Sep 2021</time></small>
        </a>
      </li>
    
  </ul>
</aside>


      </main>

      <footer class="footer">
          <img class="avatar" alt="mecid" width="100" height="100" data-proofer-ignore="true" src="https://avatars2.githubusercontent.com/mecid?v=3&s=100" srcset="https://avatars2.githubusercontent.com/mecid?v=3&s=100 1x, https://avatars2.githubusercontent.com/mecid?v=3&s=200 2x, https://avatars2.githubusercontent.com/mecid?v=3&s=300 3x, https://avatars2.githubusercontent.com/mecid?v=3&s=400 4x" />
          <small>Hi there! I am code4you,I like to program, and do some App.</small>
          <small>I'm a developer</small>
          <small>Feel free to follow me on <a href="https://github.com/code4you2021">Github</a>.</small>
        <small>
          &copy; <time datetime="2021-10-17T11:25:11+08:00">2021</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1WQVZK1CR7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-18491817-18');
    </script>
    
  </body>
</html>
